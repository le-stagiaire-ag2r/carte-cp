<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Carte des Zones de Permanence</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: Arial, sans-serif; background: #f9fafb; padding: 20px; }
        .container { max-width: 1400px; margin: 0 auto; }
        .card { background: white; border-radius: 8px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); padding: 24px; margin-bottom: 24px; }
        h1 { font-size: 28px; margin-bottom: 8px; }
        .subtitle { color: #6b7280; margin-bottom: 20px; }
        .btn-group { display: flex; gap: 12px; flex-wrap: wrap; margin-bottom: 24px; }
        button { padding: 10px 16px; border: none; border-radius: 6px; cursor: pointer; font-size: 14px; font-weight: 500; transition: all 0.2s; }
        button:hover { opacity: 0.9; }
        button:disabled { opacity: 0.5; cursor: not-allowed; }
        .btn-green { background: #10b981; color: white; }
        .btn-blue { background: #3b82f6; color: white; }
        .btn-purple { background: #8b5cf6; color: white; }
        .btn-red { background: #ef4444; color: white; }
        .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 16px; }
        label { display: block; font-size: 14px; font-weight: 500; margin-bottom: 8px; }
        input[type="text"], input[type="file"], select { width: 100%; padding: 10px; border: 1px solid #d1d5db; border-radius: 6px; font-size: 14px; }
        .color-grid { display: grid; grid-template-columns: repeat(5, 1fr); gap: 8px; }
        .color-btn { height: 48px; border: 2px solid #d1d5db; border-radius: 6px; cursor: pointer; transition: all 0.2s; }
        .color-btn.selected { border: 4px solid #000; transform: scale(1.05); }
        #map { height: 700px; border-radius: 8px; border: 2px solid #d1d5db; }
        .info-box { background: #dbeafe; border: 1px solid #93c5fd; padding: 16px; border-radius: 6px; margin-bottom: 16px; font-size: 14px; }
        .success-box { background: #d1fae5; border: 1px solid #6ee7b7; padding: 16px; border-radius: 6px; margin-bottom: 16px; font-size: 14px; }
        .warning-box { background: #fef3c7; border: 1px solid #fbbf24; padding: 16px; border-radius: 6px; margin-bottom: 16px; font-size: 14px; }
        .postal-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(120px, 1fr)); gap: 8px; }
        .postal-btn { padding: 12px; border: 2px solid #e5e7eb; border-radius: 6px; cursor: pointer; transition: all 0.2s; text-align: center; }
        .postal-btn:hover { transform: scale(1.05); }
        .postal-btn.assigned { border-color: #000; }
        .postal-code { font-weight: bold; font-size: 18px; }
        .postal-zone { font-size: 11px; margin-top: 4px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .stats { text-align: right; color: #6b7280; font-size: 14px; flex: 1; }
        .upload-box { background: #dbeafe; border: 2px solid #93c5fd; padding: 24px; border-radius: 8px; text-align: center; }
        .hidden { display: none; }
        .progress-bar { width: 100%; height: 24px; background: #e5e7eb; border-radius: 12px; overflow: hidden; margin: 16px 0; }
        .progress-fill { height: 100%; background: linear-gradient(90deg, #3b82f6, #10b981); transition: width 0.3s; display: flex; align-items: center; justify-content: center; color: white; font-weight: bold; font-size: 12px; }
        .loading-text { text-align: center; color: #6b7280; margin-top: 8px; }
        @media (max-width: 768px) { .grid-2 { grid-template-columns: 1fr; } }
    </style>
</head>
<body>
    <div class="container">
        <div class="card">
            <h1>Carte des Zones de Permanence</h1>
            <p class="subtitle">Hauts-de-France & Normandie - Carte choropl√®the optimis√©e</p>
            
            <div id="uploadSection" class="upload-box">
                <h2 style="margin-bottom: 16px;">üìÅ Charger le fichier CSV</h2>
                <p style="margin-bottom: 16px;">Pour commencer, veuillez charger votre fichier CSV</p>
                <input type="file" id="fileInput" accept=".csv">
            </div>
            
            <div id="mainSection" class="hidden">
                <div class="btn-group">
                    <button class="btn-green" id="toggleViewBtn" onclick="toggleView()">üó∫Ô∏è Vue Carte / Liste</button>
                    <button class="btn-blue" onclick="exportData()">‚¨áÔ∏è Exporter</button>
                    <button class="btn-purple" onclick="reloadCSV()">üìÅ Recharger CSV</button>
                    <button class="btn-red" onclick="clearAll()">üóëÔ∏è Effacer tout</button>
                    <div class="stats" id="stats"></div>
                </div>
                
                <div class="grid-2">
                    <div>
                        <label>üé® Couleur s√©lectionn√©e</label>
                        <div class="color-grid" id="colorGrid"></div>
                    </div>
                    <div>
                        <label>üè∑Ô∏è Nom de la zone</label>
                        <input type="text" id="zoneName" placeholder="Ex: Zone de Sarah">
                    </div>
                </div>
                
                <div class="grid-2">
                    <div>
                        <label>üîç Rechercher</label>
                        <input type="text" id="searchInput" placeholder="Commune ou code postal...">
                    </div>
                    <div>
                        <label>üìç D√©partement</label>
                        <select id="deptSelect">
                            <option value="all">Tous les d√©partements</option>
                            <option value="02">02 - Aisne</option>
                            <option value="59">59 - Nord</option>
                            <option value="60">60 - Oise</option>
                            <option value="62">62 - Pas-de-Calais</option>
                            <option value="80">80 - Somme</option>
                            <option value="14">14 - Calvados</option>
                            <option value="27">27 - Eure</option>
                            <option value="50">50 - Manche</option>
                            <option value="61">61 - Orne</option>
                            <option value="76">76 - Seine-Maritime</option>
                        </select>
                    </div>
                </div>
            </div>
        </div>
        
        <div id="mapSection" class="card hidden">
            <h2 style="margin-bottom: 16px;">Carte choropl√®the interactive</h2>
            <div class="info-box">
                <strong>üó∫Ô∏è Carte optimis√©e :</strong> Les communes sont color√©es selon leur code postal. 
                Cliquez sur une commune pour l'attribuer √† une zone. Chargement par d√©partement pour plus de rapidit√©.
            </div>
            
            <div id="loadingSection" class="hidden">
                <div class="warning-box">
                    <strong>‚è≥ Chargement optimis√© des contours...</strong><br>
                    Chargement par d√©partement (10x plus rapide). Cela prendra environ 10-15 secondes.
                </div>
                <div class="progress-bar">
                    <div class="progress-fill" id="progressFill" style="width: 0%;">0%</div>
                </div>
                <div class="loading-text" id="loadingText">Initialisation...</div>
            </div>
            
            <div id="successSection" class="success-box hidden">
                <strong>‚úÖ Carte charg√©e avec succ√®s !</strong> Les contours sont maintenant en cache. Les prochains chargements seront instantan√©s.
            </div>
            
            <div id="map"></div>
        </div>
        
        <div id="listSection" class="card hidden">
            <h2 style="margin-bottom: 16px;">Codes postaux (<span id="postalCount">0</span>)</h2>
            <p style="color: #6b7280; font-size: 14px; margin-bottom: 16px;">
                Cliquez sur un code postal pour lui attribuer la couleur et le nom de zone s√©lectionn√©s
            </p>
            <div class="postal-grid" id="postalGrid"></div>
        </div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
var postalData=[];var zones={};var selectedColor="#FF6B6B";var currentView="list";var map=null;var geoLayerGroup=null;var geoDataCache=null;var isLoadingGeo=false;var colors=[{name:"Rouge",hex:"#FF6B6B"},{name:"Orange",hex:"#FFA07A"},{name:"Jaune",hex:"#FFD93D"},{name:"Vert clair",hex:"#6BCF7F"},{name:"Vert",hex:"#2ECC71"},{name:"Turquoise",hex:"#4ECDC4"},{name:"Bleu clair",hex:"#74B9FF"},{name:"Bleu",hex:"#3498DB"},{name:"Violet",hex:"#A29BFE"},{name:"Rose",hex:"#FD79A8"},{name:"Magenta",hex:"#E056FD"},{name:"Marron",hex:"#B8860B"},{name:"Gris",hex:"#95A5A6"},{name:"Noir",hex:"#2C3E50"},{name:"Blanc",hex:"#FFFFFF"}];var departments={"02":"Aisne","59":"Nord","60":"Oise","62":"Pas-de-Calais","80":"Somme","14":"Calvados","27":"Eure","50":"Manche","61":"Orne","76":"Seine-Maritime"};document.addEventListener("DOMContentLoaded",function(){loadFromStorage();initColorGrid();document.getElementById("fileInput").addEventListener("change",handleFileUpload);document.getElementById("searchInput").addEventListener("input",updatePostalGrid);document.getElementById("deptSelect").addEventListener("change",updatePostalGrid)});function initColorGrid(){var grid=document.getElementById("colorGrid");colors.forEach(function(color){var btn=document.createElement("div");btn.className="color-btn";btn.style.backgroundColor=color.hex;btn.title=color.name;btn.onclick=function(){selectColor(color.hex,btn)};if(color.hex===selectedColor){btn.classList.add("selected")}grid.appendChild(btn)})}function selectColor(hex,element){selectedColor=hex;document.querySelectorAll(".color-btn").forEach(function(btn){return btn.classList.remove("selected")});element.classList.add("selected")}function handleFileUpload(event){var file=event.target.files[0];if(!file)return;var reader=new FileReader;reader.onload=function(e){var text=e.target.result;parseCSV(text)};reader.readAsText(file)}function parseCSV(text){var lines=text.split("\n");postalData=[];for(var i=1;i<lines.length;i++){var line=lines[i].trim();if(!line)continue;var parts=line.split(";");if(parts.length>=2){var commune=parts[0].trim();var cp=parts[1].trim();if(cp.length===4&&!isNaN(cp)){cp="0"+cp}var dept=cp.substring(0,2);if(departments[dept]){postalData.push({commune:commune,cp:cp,dept:dept})}}}saveToStorage();showMainSection();updatePostalGrid()}function showMainSection(){document.getElementById("uploadSection").classList.add("hidden");document.getElementById("mainSection").classList.remove("hidden");document.getElementById("listSection").classList.remove("hidden");updateStats()}function updateStats(){var assignedCount=Object.keys(zones).length;document.getElementById("stats").textContent=postalData.length+" communes ‚Ä¢ "+assignedCount+" codes postaux color√©s"}function updatePostalGrid(){var search=document.getElementById("searchInput").value.toLowerCase();var dept=document.getElementById("deptSelect").value;var filtered=postalData.filter(function(item){var matchDept=dept==="all"||item.dept===dept;var matchSearch=!search||item.commune.toLowerCase().includes(search)||item.cp.includes(search);return matchDept&&matchSearch});var grouped={};filtered.forEach(function(item){if(!grouped[item.cp])grouped[item.cp]=[];grouped[item.cp].push(item.commune)});var grid=document.getElementById("postalGrid");grid.innerHTML="";document.getElementById("postalCount").textContent=Object.keys(grouped).length;Object.keys(grouped).sort().forEach(function(cp){var zone=zones[cp];var communes=grouped[cp];var btn=document.createElement("div");btn.className="postal-btn"+(zone?" assigned":"");btn.style.backgroundColor=zone?zone.color:"#ffffff";btn.style.color=zone&&zone.color!=="#FFFFFF"?"#fff":"#000";btn.title=communes.join(", ")+"\n"+(zone?zone.name:"Non attribu√©");btn.onclick=function(){return togglePostalCode(cp)};btn.innerHTML='<div class="postal-code">'+cp+"</div>"+(zone?'<div class="postal-zone">'+zone.name+"</div>":"");grid.appendChild(btn)})}function togglePostalCode(cp){var zoneName=document.getElementById("zoneName").value||"Zone sans nom";if(zones[cp]&&zones[cp].color===selectedColor){delete zones[cp]}else{zones[cp]={color:selectedColor,name:zoneName}}saveToStorage();updatePostalGrid();updateStats();if(map&&geoDataCache){updateMapColors()}}function toggleView(){if(currentView==="list"){currentView="map";document.getElementById("listSection").classList.add("hidden");document.getElementById("mapSection").classList.remove("hidden");if(!map){initMap()}else if(!geoDataCache&&!isLoadingGeo){loadGeoData()}}else{currentView="list";document.getElementById("mapSection").classList.add("hidden");document.getElementById("listSection").classList.remove("hidden")}}function initMap(){map=L.map("map").setView([49.5,1.5],8);L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",{attribution:"¬© OpenStreetMap",maxZoom:19}).addTo(map);geoLayerGroup=L.layerGroup().addTo(map);loadGeoData()}async function loadGeoData(){if(isLoadingGeo)return;isLoadingGeo=true;document.getElementById("loadingSection").classList.remove("hidden");document.getElementById("successSection").classList.add("hidden");document.getElementById("toggleViewBtn").disabled=true;var depts=Object.keys(departments);var total=depts.length;var loaded=0;var allFeatures=[];document.getElementById("loadingText").textContent="Chargement par d√©partement ("+total+" d√©partements)...";for(var i=0;i<depts.length;i++){var dept=depts[i];document.getElementById("loadingText").textContent="Chargement du d√©partement "+dept+" ("+departments[dept]+")...";try{var response=await fetch("https://geo.api.gouv.fr/departements/"+dept+"/communes?fields=nom,code,codesPostaux&format=geojson&geometry=contour");if(response.ok){var data=await response.json();            if(data.features){data.features.forEach(function(feature){var communeName=feature.properties.nom;var apiCodesPostaux=feature.properties.codesPostaux||[];var matchingItems=postalData.filter(function(d){var nameMatch=d.commune.toLowerCase()===communeName.toLowerCase();var cpMatch=apiCodesPostaux.includes(d.cp);return nameMatch||cpMatch});if(matchingItems.length>0){matchingItems.forEach(function(item){var featureCopy=JSON.parse(JSON.stringify(feature));featureCopy.properties.codePostal=item.cp;featureCopy.properties.matchedCommune=item.commune;if(featureCopy.geometry&&featureCopy.geometry.coordinates){try{var simplified=simplifyCoordinates(featureCopy.geometry.coordinates,.001);featureCopy.geometry.coordinates=simplified}catch(e){}}allFeatures.push(featureCopy)})}else if(apiCodesPostaux.length>0){var firstCP=apiCodesPostaux[0];if(firstCP.substring(0,2)===dept){feature.properties.codePostal=firstCP;if(feature.geometry&&feature.geometry.coordinates){try{var simplified=simplifyCoordinates(feature.geometry.coordinates,.001);feature.geometry.coordinates=simplified}catch(e){}}allFeatures.push(feature)}}})}}}catch(error){console.log("Erreur d√©partement "+dept)}loaded++;var percent=Math.round(loaded/total*100);document.getElementById("progressFill").style.width=percent+"%";document.getElementById("progressFill").textContent=percent+"%"}geoDataCache=allFeatures;try{localStorage.setItem("geoDataCache",JSON.stringify(allFeatures))}catch(e){console.log("Cache trop volumineux, non sauvegard√©")}document.getElementById("loadingSection").classList.add("hidden");document.getElementById("successSection").classList.remove("hidden");setTimeout(function(){document.getElementById("successSection").classList.add("hidden")},5e3);document.getElementById("toggleViewBtn").disabled=false;isLoadingGeo=false;displayGeoData()}function simplifyCoordinates(coords,tolerance){if(!coords||coords.length===0)return coords;if(typeof coords[0]==="number"){return coords}if(Array.isArray(coords[0])&&typeof coords[0][0]==="number"){if(coords.length<=10)return coords;var simplified=[];var step=Math.max(1,Math.floor(coords.length/50));for(var i=0;i<coords.length;i+=step){simplified.push(coords[i])}if(simplified[simplified.length-1]!==coords[coords.length-1]){simplified.push(coords[coords.length-1])}return simplified}return coords.map(function(c){return simplifyCoordinates(c,tolerance)})}function displayGeoData(){if(!map||!geoDataCache)return;geoLayerGroup.clearLayers();var displayed=0;geoDataCache.forEach(function(feature){var cp=feature.properties.codePostal;if(!cp)return;var zone=zones[cp];var color=zone?zone.color:"#e5e7eb";var layer=L.geoJSON(feature,{style:{fillColor:color,fillOpacity:.7,color:"#666",weight:1},onEachFeature:function(f,l){l.on("click",function(){togglePostalCode(cp)});var name=f.properties.nom||f.properties.matchedCommune||"";l.bindTooltip("<strong>"+name+"</strong><br/>CP: "+cp+(zone?"<br/><span style='color:"+color+";font-weight:bold;'>"+zone.name+"</span>":""),{sticky:true})}});geoLayerGroup.addLayer(layer);displayed++});console.log("Communes affich√©es: "+displayed+"/"+geoDataCache.length)}}function updateMapColors(){displayGeoData()}function exportData(){var colorGroups={};Object.entries(zones).forEach(function(a){var cp=a[0];var data=a[1];if(!colorGroups[data.color]){colorGroups[data.color]={name:data.name,postalCodes:[]}}colorGroups[data.color].postalCodes.push(cp)});var text="EXPORT DES ZONES DE PERMANENCE\n================================\n\n";Object.entries(colorGroups).forEach(function(a){var color=a[0];var data=a[1];var colorName=colors.find(function(c){return c.hex===color});text+=data.name+" ("+(colorName?colorName.name:"Couleur personnalis√©e")+")\n";text+="Codes postaux ("+data.postalCodes.length+"): "+data.postalCodes.sort().join(", ")+"\n\n"});var blob=new Blob([text],{type:"text/plain"});var url=URL.createObjectURL(blob);var a=document.createElement("a");a.href=url;a.download="zones-permanence.txt";a.click()}function clearAll(){if(confirm("Effacer toutes les zones color√©es ?")){zones={};saveToStorage();updatePostalGrid();updateStats();if(map&&geoDataCache){updateMapColors()}}}function reloadCSV(){postalData=[];zones={};geoDataCache=null;localStorage.clear();document.getElementById("uploadSection").classList.remove("hidden");document.getElementById("mainSection").classList.add("hidden");document.getElementById("listSection").classList.add("hidden");document.getElementById("mapSection").classList.add("hidden");document.getElementById("fileInput").value="";if(map){map.remove();map=null;geoLayerGroup=null}}function saveToStorage(){localStorage.setItem("postalData",JSON.stringify(postalData));localStorage.setItem("zones",JSON.stringify(zones))}function loadFromStorage(){var savedData=localStorage.getItem("postalData");var savedZones=localStorage.getItem("zones");var savedGeo=localStorage.getItem("geoDataCache");if(savedData){postalData=JSON.parse(savedData);showMainSection();updatePostalGrid()}if(savedZones){zones=JSON.parse(savedZones);updatePostalGrid();updateStats()}if(savedGeo){try{geoDataCache=JSON.parse(savedGeo)}catch(e){localStorage.removeItem("geoDataCache")}}}
    </script>
</body>
</html>
