<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Carte des Zones de Permanence</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: Arial, sans-serif; background: #f9fafb; padding: 20px; }
        .container { max-width: 1400px; margin: 0 auto; }
        .card { background: white; border-radius: 8px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); padding: 24px; margin-bottom: 24px; }
        h1 { font-size: 28px; margin-bottom: 8px; }
        .subtitle { color: #6b7280; margin-bottom: 20px; }
        .btn-group { display: flex; gap: 12px; flex-wrap: wrap; margin-bottom: 24px; }
        button { padding: 10px 16px; border: none; border-radius: 6px; cursor: pointer; font-size: 14px; font-weight: 500; transition: all 0.2s; }
        button:hover { opacity: 0.9; }
        button:disabled { opacity: 0.5; cursor: not-allowed; }
        .btn-green { background: #10b981; color: white; }
        .btn-blue { background: #3b82f6; color: white; }
        .btn-purple { background: #8b5cf6; color: white; }
        .btn-red { background: #ef4444; color: white; }
        .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 16px; }
        label { display: block; font-size: 14px; font-weight: 500; margin-bottom: 8px; }
        input[type="text"], input[type="file"], select { width: 100%; padding: 10px; border: 1px solid #d1d5db; border-radius: 6px; font-size: 14px; }
        .color-grid { display: grid; grid-template-columns: repeat(5, 1fr); gap: 8px; }
        .color-btn { height: 48px; border: 2px solid #d1d5db; border-radius: 6px; cursor: pointer; transition: all 0.2s; }
        .color-btn.selected { border: 4px solid #000; transform: scale(1.05); }
        #map { height: 700px; border-radius: 8px; border: 2px solid #d1d5db; }
        .info-box { background: #dbeafe; border: 1px solid #93c5fd; padding: 16px; border-radius: 6px; margin-bottom: 16px; font-size: 14px; }
        .success-box { background: #d1fae5; border: 1px solid #6ee7b7; padding: 16px; border-radius: 6px; margin-bottom: 16px; font-size: 14px; }
        .warning-box { background: #fef3c7; border: 1px solid #fbbf24; padding: 16px; border-radius: 6px; margin-bottom: 16px; font-size: 14px; }
        .postal-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(120px, 1fr)); gap: 8px; }
        .postal-btn { padding: 12px; border: 2px solid #e5e7eb; border-radius: 6px; cursor: pointer; transition: all 0.2s; text-align: center; }
        .postal-btn:hover { transform: scale(1.05); }
        .postal-btn.assigned { border-color: #000; }
        .postal-code { font-weight: bold; font-size: 18px; }
        .postal-zone { font-size: 11px; margin-top: 4px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .stats { text-align: right; color: #6b7280; font-size: 14px; flex: 1; }
        .upload-box { background: #dbeafe; border: 2px solid #93c5fd; padding: 24px; border-radius: 8px; text-align: center; }
        .hidden { display: none; }
        .progress-bar { width: 100%; height: 24px; background: #e5e7eb; border-radius: 12px; overflow: hidden; margin: 16px 0; }
        .progress-fill { height: 100%; background: linear-gradient(90deg, #3b82f6, #10b981); transition: width 0.3s; display: flex; align-items: center; justify-content: center; color: white; font-weight: bold; font-size: 12px; }
        .loading-text { text-align: center; color: #6b7280; margin-top: 8px; }
        .flag-section { background: #fef3c7; border: 2px solid #fbbf24; padding: 16px; border-radius: 8px; margin-bottom: 16px; }
        .flag-controls { display: flex; gap: 12px; margin-bottom: 12px; flex-wrap: wrap; align-items: center; }
        .flag-mode-btn { padding: 8px 16px; border: 2px solid #000; border-radius: 6px; cursor: pointer; font-weight: bold; transition: all 0.2s; }
        .flag-mode-btn.active { transform: scale(1.1); box-shadow: 0 0 10px rgba(0,0,0,0.3); }
        .flag-list { display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 8px; margin-top: 12px; }
        .flag-item { padding: 10px; border: 2px solid #000; border-radius: 6px; display: flex; justify-content: space-between; align-items: center; }
        .flag-delete { background: #ef4444; color: white; border: none; padding: 4px 8px; border-radius: 4px; cursor: pointer; font-size: 12px; }
        .zone-filter { background: #e0e7ff; border: 2px solid #818cf8; padding: 16px; border-radius: 8px; margin-bottom: 16px; }
        .zone-checkboxes { display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 8px; margin-top: 12px; }
        .zone-checkbox-item { display: flex; align-items: center; gap: 8px; padding: 8px; background: white; border-radius: 6px; cursor: pointer; }
        .zone-checkbox-item:hover { background: #f3f4f6; }
        .zone-checkbox-item input[type="checkbox"] { cursor: pointer; width: 18px; height: 18px; }
        .zone-color-indicator { width: 24px; height: 24px; border-radius: 4px; border: 2px solid #000; }
        @media (max-width: 768px) { .grid-2 { grid-template-columns: 1fr; } }
    </style>
</head>
<body>
    <div class="container">
        <div class="card">
            <h1>Carte des Zones de Permanence</h1>
            <p class="subtitle">Hauts-de-France & Normandie</p>
            
            <div id="uploadSection" class="upload-box">
                <h2 style="margin-bottom: 16px;">Charger le fichier CSV</h2>
                <p style="margin-bottom: 12px; color: #6b7280;">Le fichier sera automatiquement sauvegard√© dans votre navigateur</p>
                <p style="margin-bottom: 16px; font-size: 13px; color: #059669;">Vous n'aurez √† le charger qu'une seule fois</p>
                <input type="file" id="fileInput" accept=".csv">
            </div>
            
            <div id="mainSection" class="hidden">
                <div class="btn-group">
                    <button class="btn-green" id="toggleViewBtn" onclick="toggleView()">Vue Carte / Liste</button>
                    <button class="btn-blue" onclick="exportData()">‚¨áÔ∏è Exporter TXT</button>
                    <button class="btn-blue" onclick="exportJSON()">‚¨áÔ∏è Exporter JSON</button>
                    <button class="btn-blue" onclick="document.getElementById('importJSON').click()">‚¨ÜÔ∏è Importer JSON</button>
                    <input type="file" id="importJSON" accept=".json" style="display:none;" onchange="importJSON(event)">
                    <button class="btn-purple" onclick="reloadCSV()">üìÅ Recharger CSV</button>
                    <button class="btn-purple" onclick="reloadMap()">üó∫Ô∏è Recharger Carte</button>
                    <button class="btn-red" onclick="clearAll()">üóëÔ∏è Effacer tout</button>
                    <div class="stats" id="stats"></div>
                </div>
                
                <div class="grid-2">
                    <div>
                        <label>Couleur s√©lectionn√©e</label>
                        <div class="color-grid" id="colorGrid"></div>
                    </div>
                    <div>
                        <label>Nom de la zone</label>
                        <input type="text" id="zoneName" placeholder="Ex: Zone de Sarah">
                    </div>
                </div>
                
                <div class="grid-2">
                    <div>
                        <label>Rechercher</label>
                        <input type="text" id="searchInput" placeholder="Commune ou code postal...">
                    </div>
                    <div>
                        <label>D√©partement</label>
                        <select id="deptSelect">
                            <option value="all">Tous les d√©partements</option>
                            <option value="02">02 - Aisne</option>
                            <option value="59">59 - Nord</option>
                            <option value="60">60 - Oise</option>
                            <option value="62">62 - Pas-de-Calais</option>
                            <option value="80">80 - Somme</option>
                            <option value="14">14 - Calvados</option>
                            <option value="27">27 - Eure</option>
                            <option value="50">50 - Manche</option>
                            <option value="61">61 - Orne</option>
                            <option value="76">76 - Seine-Maritime</option>
                        </select>
                    </div>
                </div>
                
                <div class="zone-filter">
                    <h3 style="margin-bottom: 8px;">üéØ Filtre par zones</h3>
                    <p style="font-size: 13px; color: #6b7280; margin-bottom: 12px;">Cochez les zones √† afficher</p>
                    <div class="zone-checkboxes" id="zoneFilterList"></div>
                </div>
            </div>
        </div>
        
        <div id="mapSection" class="card hidden">
            <h2 style="margin-bottom: 16px;">Carte choropl√®the interactive</h2>
            <div class="info-box">
                <strong>Carte interactive :</strong> Les communes sont color√©es selon leur code postal. 
                Cliquez sur une commune pour l'attribuer √† une zone. Tous les d√©partements sont affich√©s.
            </div>
            
            <div class="flag-section">
                <h3 style="margin-bottom: 12px;">üö© Gestion des drapeaux</h3>
                <div class="flag-controls">
                    <button class="flag-mode-btn" id="flagPermanenceActive" style="background:#FF1744;color:white;" onclick="setFlagMode('permanence_active')">
                        üö© Permanence Active
                    </button>
                    <button class="flag-mode-btn" id="flagPermanenceInactive" style="background:#2962FF;color:white;" onclick="setFlagMode('permanence_inactive')">
                        üèÅ Permanence Inactive
                    </button>
                    <button class="flag-mode-btn" id="flagAgence" style="background:#FF9800;color:white;" onclick="setFlagMode('agence')">
                        üè¢ Agence
                    </button>
                    <button class="btn-red" onclick="disableFlagMode()">‚ùå Annuler</button>
                    <button class="btn-purple" onclick="toggleZonesVisibility()">üëÅÔ∏è Masquer/Afficher Zones</button>
                    <input type="text" id="flagName" placeholder="Nom du drapeau..." style="flex: 1; min-width: 200px;">
                </div>
                <div id="flagModeInfo" class="hidden" style="background:#fff3cd;padding:8px;border-radius:4px;margin-bottom:8px;font-size:13px;">
                    <strong>Mode placement activ√© :</strong> Cliquez sur la carte pour placer un drapeau (rayon de 20km automatique)
                </div>
                <div class="flag-list" id="flagList"></div>
            </div>
            
            <div id="loadingSection" class="hidden">
                <div class="warning-box">
                    <strong>Chargement des contours...</strong><br>
                    Chargement de tous les d√©partements. Cela prendra environ 15-20 secondes.
                </div>
                <div class="progress-bar">
                    <div class="progress-fill" id="progressFill" style="width: 0%;">0%</div>
                </div>
                <div class="loading-text" id="loadingText">Initialisation...</div>
            </div>
            
            <div id="successSection" class="success-box hidden">
                <strong>Carte charg√©e avec succ√®s</strong>
            </div>
            
            <div id="map"></div>
        </div>
        
        <div id="listSection" class="card hidden">
            <h2 style="margin-bottom: 16px;">Codes postaux (<span id="postalCount">0</span>)</h2>
            <p style="color: #6b7280; font-size: 14px; margin-bottom: 16px;">
                Cliquez sur un code postal pour lui attribuer la couleur et le nom de zone s√©lectionn√©s
            </p>
            <div class="postal-grid" id="postalGrid"></div>
        </div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        var postalData = [];
        var zones = {};
        var selectedColor = "#FF6B6B";
        var currentView = "list";
        var map = null;
        var geoLayerGroup = null;
        var geoDataCache = null;
        var isLoadingGeo = false;
        var flags = [];
        var flagMode = null;
        var flagMarkers = L.layerGroup();
        var flagCircles = L.layerGroup();
        var activeZoneFilters = {};
        var zonesVisible = true;

        var colors = [
            {name:"Rouge",hex:"#FF6B6B"},{name:"Orange",hex:"#FFA07A"},{name:"Jaune",hex:"#FFD93D"},
            {name:"Vert clair",hex:"#6BCF7F"},{name:"Vert",hex:"#2ECC71"},{name:"Turquoise",hex:"#4ECDC4"},
            {name:"Bleu clair",hex:"#74B9FF"},{name:"Bleu",hex:"#3498DB"},{name:"Violet",hex:"#A29BFE"},
            {name:"Rose",hex:"#FD79A8"},{name:"Magenta",hex:"#E056FD"},{name:"Marron",hex:"#B8860B"},
            {name:"Gris",hex:"#95A5A6"},{name:"Noir",hex:"#2C3E50"},{name:"Blanc",hex:"#FFFFFF"}
        ];

        var departments = {
            "02":"Aisne","59":"Nord","60":"Oise","62":"Pas-de-Calais","80":"Somme",
            "14":"Calvados","27":"Eure","50":"Manche","61":"Orne","76":"Seine-Maritime"
        };

        document.addEventListener("DOMContentLoaded", function() {
            loadFromStorage();
            initColorGrid();
            initZoneFilters();
            document.getElementById("fileInput").addEventListener("change", handleFileUpload);
            document.getElementById("searchInput").addEventListener("input", updatePostalGrid);
            document.getElementById("deptSelect").addEventListener("change", updatePostalGrid);
        });

        function initColorGrid() {
            var grid = document.getElementById("colorGrid");
            var fragment = document.createDocumentFragment();
            for (var i = 0; i < colors.length; i++) {
                var color = colors[i];
                var btn = document.createElement("div");
                btn.className = "color-btn";
                btn.style.backgroundColor = color.hex;
                btn.title = color.name;
                btn.onclick = (function(c, b) {
                    return function() { selectColor(c.hex, b); };
                })(color, btn);
                if (color.hex === selectedColor) btn.classList.add("selected");
                fragment.appendChild(btn);
            }
            grid.appendChild(fragment);
        }

        function selectColor(hex, element) {
            selectedColor = hex;
            var buttons = document.querySelectorAll(".color-btn");
            for (var i = 0; i < buttons.length; i++) {
                buttons[i].classList.remove("selected");
            }
            element.classList.add("selected");
        }

        function handleFileUpload(event) {
            var file = event.target.files[0];
            if (!file) return;
            
            var reader = new FileReader();
            reader.onload = function(e) {
                parseCSV(e.target.result);
            };
            reader.readAsText(file);
        }

        function parseCSV(text) {
            var lines = text.split("\n");
            postalData = [];
            
            for (var i = 1; i < lines.length; i++) {
                var line = lines[i].trim();
                if (!line) continue;
                
                var parts = line.split(";");
                if (parts.length >= 2) {
                    var commune = parts[0].trim();
                    var cp = parts[1].trim();
                    
                    if (cp.length === 4 && !isNaN(cp)) {
                        cp = "0" + cp;
                    }
                    
                    var dept = cp.substring(0, 2);
                    if (departments[dept]) {
                        postalData.push({commune: commune, cp: cp, dept: dept});
                    }
                }
            }
            
            saveToStorage();
            showMainSection();
            updatePostalGrid();
        }

        function showMainSection() {
            document.getElementById("uploadSection").classList.add("hidden");
            document.getElementById("mainSection").classList.remove("hidden");
            document.getElementById("listSection").classList.remove("hidden");
            updateStats();
        }

        function updateStats() {
            var assignedCount = Object.keys(zones).length;
            document.getElementById("stats").textContent = postalData.length + " communes ‚Ä¢ " + assignedCount + " codes postaux color√©s";
        }

        function initZoneFilters() {
            var zoneNames = {};
            var cpList = Object.keys(zones);
            for (var i = 0; i < cpList.length; i++) {
                var zoneName = zones[cpList[i]].name;
                if (!zoneNames[zoneName]) {
                    zoneNames[zoneName] = {
                        color: zones[cpList[i]].color,
                        count: 0
                    };
                }
                zoneNames[zoneName].count++;
            }
            
            var container = document.getElementById("zoneFilterList");
            container.innerHTML = "";
            var sortedZones = Object.keys(zoneNames).sort();
            
            if (sortedZones.length === 0) {
                container.innerHTML = '<p style="color:#6b7280;font-size:13px;">Aucune zone cr√©√©e pour le moment</p>';
                return;
            }
            
            var fragment = document.createDocumentFragment();
            for (var i = 0; i < sortedZones.length; i++) {
                var zoneName = sortedZones[i];
                var zoneData = zoneNames[zoneName];
                
                if (activeZoneFilters[zoneName] === undefined) {
                    activeZoneFilters[zoneName] = true;
                }
                
                var label = document.createElement("label");
                label.className = "zone-checkbox-item";
                
                var checkbox = document.createElement("input");
                checkbox.type = "checkbox";
                checkbox.checked = activeZoneFilters[zoneName];
                checkbox.onchange = (function(name) {
                    return function(e) {
                        activeZoneFilters[name] = e.target.checked;
                        updatePostalGrid();
                        if (map && geoDataCache) updateMapColors();
                    };
                })(zoneName);
                
                var colorDiv = document.createElement("div");
                colorDiv.className = "zone-color-indicator";
                colorDiv.style.backgroundColor = zoneData.color;
                
                var text = document.createElement("span");
                text.style.flex = "1";
                text.style.fontWeight = "500";
                text.textContent = zoneName + " (" + zoneData.count + " CP)";
                
                label.appendChild(checkbox);
                label.appendChild(colorDiv);
                label.appendChild(text);
                fragment.appendChild(label);
            }
            container.appendChild(fragment);
        }

        function updatePostalGrid() {
            var search = document.getElementById("searchInput").value.toLowerCase();
            var dept = document.getElementById("deptSelect").value;
            
            var filtered = [];
            for (var i = 0; i < postalData.length; i++) {
                var item = postalData[i];
                var matchDept = dept === "all" || item.dept === dept;
                var matchSearch = !search || item.commune.toLowerCase().indexOf(search) !== -1 || item.cp.indexOf(search) !== -1;
                
                var zone = zones[item.cp];
                var matchZone = !zone || activeZoneFilters[zone.name];
                
                if (matchDept && matchSearch && matchZone) {
                    filtered.push(item);
                }
            }

            var grouped = {};
            for (var i = 0; i < filtered.length; i++) {
                var item = filtered[i];
                if (!grouped[item.cp]) grouped[item.cp] = [];
                grouped[item.cp].push(item.commune);
            }

            var grid = document.getElementById("postalGrid");
            grid.innerHTML = "";
            var sortedCps = Object.keys(grouped).sort();
            document.getElementById("postalCount").textContent = sortedCps.length;

            var fragment = document.createDocumentFragment();
            for (var i = 0; i < sortedCps.length; i++) {
                var cp = sortedCps[i];
                var zone = zones[cp];
                var communes = grouped[cp];
                var btn = document.createElement("div");
                btn.className = "postal-btn" + (zone ? " assigned" : "");
                btn.style.backgroundColor = zone ? zone.color : "#ffffff";
                btn.style.color = zone && zone.color !== "#FFFFFF" ? "#fff" : "#000";
                btn.title = communes.join(", ") + "\n" + (zone ? zone.name : "Non attribu√©");
                btn.onclick = (function(postal) {
                    return function() { togglePostalCode(postal); };
                })(cp);
                btn.innerHTML = '<div class="postal-code">' + cp + "</div>" + 
                    (zone ? '<div class="postal-zone">' + zone.name + "</div>" : "");
                fragment.appendChild(btn);
            }
            grid.appendChild(fragment);
        }

        function togglePostalCode(cp) {
            var zoneName = document.getElementById("zoneName").value || "Zone sans nom";
            if (zones[cp] && zones[cp].color === selectedColor) {
                delete zones[cp];
            } else {
                zones[cp] = {color: selectedColor, name: zoneName};
            }
            saveToStorage();
            updatePostalGrid();
            updateStats();
            initZoneFilters();
            if (map && geoDataCache) updateMapColors();
        }

        function toggleView() {
            if (currentView === "list") {
                currentView = "map";
                document.getElementById("listSection").classList.add("hidden");
                document.getElementById("mapSection").classList.remove("hidden");
                if (!map) {
                    initMap();
                } else if (!geoDataCache && !isLoadingGeo) {
                    loadGeoData();
                }
            } else {
                currentView = "list";
                document.getElementById("mapSection").classList.add("hidden");
                document.getElementById("listSection").classList.remove("hidden");
            }
        }

        function initMap() {
            map = L.map("map", {
                preferCanvas: false,
                renderer: L.svg({ padding: 0.5 })
            }).setView([49.5, 1.5], 8);
            
            L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
                attribution: "¬© OpenStreetMap",
                maxZoom: 19,
                updateWhenIdle: true,
                updateWhenZooming: false
            }).addTo(map);
            
            // Ordre d'affichage : g√©om√©tries en bas, cercles au milieu, marqueurs en haut
            geoLayerGroup = L.layerGroup().addTo(map);
            flagCircles.addTo(map);
            flagMarkers.addTo(map);
            
            map.on('movestart', function() {
                map.closePopup();
                map.eachLayer(function(layer) {
                    if (layer.closeTooltip) {
                        layer.closeTooltip();
                    }
                });
            });
            
            map.on('click', function(e) {
                if (flagMode) {
                    addFlag(e.latlng);
                }
            });
            
            loadGeoData();
            displayFlags();
        }

        async function loadGeoData() {
            if (isLoadingGeo) return;
            isLoadingGeo = true;
            document.getElementById("loadingSection").classList.remove("hidden");
            document.getElementById("successSection").classList.add("hidden");
            document.getElementById("toggleViewBtn").disabled = true;

            var depts = Object.keys(departments);
            var total = depts.length;
            var loaded = 0;
            var cpToGeometry = {};

            for (var i = 0; i < depts.length; i++) {
                var dept = depts[i];
                document.getElementById("loadingText").textContent = "Chargement " + dept + "...";
                
                try {
                    var response = await fetch("https://geo.api.gouv.fr/departements/" + dept + "/communes?fields=nom,codesPostaux&format=geojson&geometry=contour");
                    if (response.ok) {
                        var data = await response.json();
                        if (data.features) {
                            for (var j = 0; j < data.features.length; j++) {
                                var feature = data.features[j];
                                var communeName = feature.properties.nom;
                                var apiCps = feature.properties.codesPostaux || [];
                                
                                for (var k = 0; k < apiCps.length; k++) {
                                    var cp = apiCps[k];
                                    if (cp.substring(0, 2) === dept) {
                                        if (!cpToGeometry[cp]) {
                                            cpToGeometry[cp] = {
                                                communes: [],
                                                geometries: []
                                            };
                                        }
                                        
                                        if (cpToGeometry[cp].communes.indexOf(communeName) === -1) {
                                            cpToGeometry[cp].communes.push(communeName);
                                        }
                                        
                                        if (feature.geometry && feature.geometry.coordinates) {
                                            cpToGeometry[cp].geometries.push({
                                                type: feature.geometry.type,
                                                coords: simplifyCoordinates(feature.geometry.coordinates, 0.004),
                                                commune: communeName
                                            });
                                        }
                                        break;
                                    }
                                }
                            }
                        }
                    }
                } catch (error) {
                    console.log("Erreur " + dept);
                }
                
                loaded++;
                var percent = Math.round((loaded / total) * 100);
                document.getElementById("progressFill").style.width = percent + "%";
                document.getElementById("progressFill").textContent = percent + "%";
                
                await new Promise(function(resolve) { setTimeout(resolve, 20); });
            }

            geoDataCache = cpToGeometry;
            document.getElementById("loadingSection").classList.add("hidden");
            document.getElementById("successSection").classList.remove("hidden");
            setTimeout(function() {
                document.getElementById("successSection").classList.add("hidden");
            }, 5000);
            document.getElementById("toggleViewBtn").disabled = false;
            isLoadingGeo = false;
            displayGeoData();
        }

        function simplifyCoordinates(coords, tolerance) {
            if (!coords || coords.length === 0) return coords;
            
            if (typeof coords[0] === 'number') {
                return coords;
            }
            
            if (Array.isArray(coords[0]) && typeof coords[0][0] === 'number') {
                if (coords.length <= 12) return coords;
                
                var simplified = [coords[0]];
                var step = Math.max(2, Math.floor(coords.length / 10));
                
                for (var i = step; i < coords.length - 1; i += step) {
                    simplified.push(coords[i]);
                }
                
                simplified.push(coords[coords.length - 1]);
                return simplified;
            }
            
            var result = [];
            for (var i = 0; i < coords.length; i++) {
                result.push(simplifyCoordinates(coords[i], tolerance));
            }
            return result;
        }

        function displayGeoData() {
            if (!map || !geoDataCache) return;
            geoLayerGroup.clearLayers();
            
            var cps = Object.keys(geoDataCache);
            var batchSize = 15;
            var index = 0;
            
            function displayBatch() {
                var end = Math.min(index + batchSize, cps.length);
                
                for (var i = index; i < end; i++) {
                    var cp = cps[i];
                    var cpData = geoDataCache[cp];
                    var zone = zones[cp];
                    
                    // Si la zone est d√©coch√©e, afficher en gris au lieu de masquer
                    var color;
                    if (zone && !activeZoneFilters[zone.name]) {
                        color = "#e5e7eb"; // Gris par d√©faut (zone d√©coch√©e)
                    } else {
                        color = zone ? zone.color : "#e5e7eb";
                    }
                    
                    for (var j = 0; j < cpData.geometries.length; j++) {
                        var geom = cpData.geometries[j];
                        var feature = {
                            type: "Feature",
                            properties: { 
                                cp: cp,
                                commune: geom.commune
                            },
                            geometry: {
                                type: geom.type,
                                coordinates: geom.coords
                            }
                        };
                        
                        var layer = L.geoJSON(feature, {
                            style: {
                                fillColor: color,
                                fillOpacity: 0.7,
                                color: "#666",
                                weight: 1
                            },
                            onEachFeature: (function(cpClosure, communeClosure, zoneClosure, colorClosure) {
                                return function(f, l) {
                                    l.on("click", function(e) {
                                        if (!flagMode) {
                                            togglePostalCode(cpClosure);
                                        }
                                    });
                                    l.bindTooltip("<strong>" + communeClosure + "</strong><br/>CP: " + cpClosure + 
                                        (zoneClosure ? "<br/><span style='color:" + colorClosure + ";font-weight:bold;'>" + zoneClosure.name + "</span>" : ""),
                                        {sticky: true}
                                    );
                                };
                            })(cp, geom.commune, zone, color)
                        });
                        geoLayerGroup.addLayer(layer);
                    }
                }
                
                index = end;
                
                if (index < cps.length) {
                    requestAnimationFrame(displayBatch);
                }
            }
            
            displayBatch();
        }

        function updateMapColors() {
            displayGeoData();
        }

        function setFlagMode(type) {
            flagMode = type;
            document.getElementById("flagModeInfo").classList.remove("hidden");
            document.getElementById("flagPermanenceActive").classList.remove("active");
            document.getElementById("flagPermanenceInactive").classList.remove("active");
            document.getElementById("flagAgence").classList.remove("active");
            
            if (type === "permanence_active") {
                document.getElementById("flagPermanenceActive").classList.add("active");
            } else if (type === "permanence_inactive") {
                document.getElementById("flagPermanenceInactive").classList.add("active");
            } else if (type === "agence") {
                document.getElementById("flagAgence").classList.add("active");
            }
            
            if (map) map.getContainer().style.cursor = "crosshair";
        }

        function disableFlagMode() {
            flagMode = null;
            document.getElementById("flagModeInfo").classList.add("hidden");
            document.getElementById("flagPermanenceActive").classList.remove("active");
            document.getElementById("flagPermanenceInactive").classList.remove("active");
            document.getElementById("flagAgence").classList.remove("active");
            if (map) map.getContainer().style.cursor = "";
        }

        function addFlag(latlng) {
            var name = document.getElementById("flagName").value || "Sans nom";
            var flag = {
                id: Date.now(),
                type: flagMode,
                name: name,
                lat: latlng.lat,
                lng: latlng.lng
            };
            flags.push(flag);
            saveToStorage();
            displayFlags();
            updateFlagList();
            document.getElementById("flagName").value = "";
        }

        function displayFlags() {
            if (!map) return;
            flagMarkers.clearLayers();
            flagCircles.clearLayers();
            
            for (var i = 0; i < flags.length; i++) {
                var flag = flags[i];
                var color, icon, label;
                
                if (flag.type === "permanence_active") {
                    color = "#FF1744";
                    icon = "üö©";
                    label = "Permanence Active";
                } else if (flag.type === "permanence_inactive") {
                    color = "#2962FF";
                    icon = "üèÅ";
                    label = "Permanence Inactive";
                } else if (flag.type === "agence") {
                    color = "#FF9800";
                    icon = "üè¢";
                    label = "Agence";
                }
                
                // Ajouter un cercle de 20km autour du drapeau
                var circle = L.circle([flag.lat, flag.lng], {
                    color: color,
                    fillColor: color,
                    fillOpacity: 0.15,
                    radius: 20000,
                    weight: 3,
                    dashArray: '10, 10',
                    pane: 'overlayPane'
                });
                flagCircles.addLayer(circle);
                
                // Ajouter le marqueur drapeau
                var customIcon = L.divIcon({
                    className: 'custom-flag-marker',
                    html: '<div style="font-size:32px;text-shadow:2px 2px 4px rgba(0,0,0,0.5);">' + icon + '</div>',
                    iconSize: [32, 32],
                    iconAnchor: [16, 32]
                });
                
                var marker = L.marker([flag.lat, flag.lng], {icon: customIcon});
                marker.bindPopup("<strong>" + icon + " " + label + 
                    "</strong><br/>" + flag.name + "<br/><small style='color:#666;'>Rayon: 20km</small>");
                marker.on('click', function() {
                    this.openPopup();
                });
                flagMarkers.addLayer(marker);
            }
        }

        function updateFlagList() {
            var container = document.getElementById("flagList");
            container.innerHTML = "";
            
            if (flags.length === 0) {
                container.innerHTML = '<p style="color:#6b7280;font-size:13px;">Aucun drapeau plac√©</p>';
                return;
            }
            
            var fragment = document.createDocumentFragment();
            for (var i = 0; i < flags.length; i++) {
                var flag = flags[i];
                var div = document.createElement("div");
                div.className = "flag-item";
                
                var icon, bgColor;
                if (flag.type === "permanence_active") {
                    icon = "üö©";
                    bgColor = "#ffcdd2";
                } else if (flag.type === "permanence_inactive") {
                    icon = "üèÅ";
                    bgColor = "#bbdefb";
                } else if (flag.type === "agence") {
                    icon = "üè¢";
                    bgColor = "#ffe0b2";
                }
                
                div.style.backgroundColor = bgColor;
                
                var span = document.createElement("span");
                span.innerHTML = icon + " " + flag.name + " <small style='color:#666;'>(20km)</small>";
                span.style.fontWeight = "500";
                
                var btn = document.createElement("button");
                btn.className = "flag-delete";
                btn.textContent = "Supprimer";
                btn.onclick = (function(flagId) {
                    return function() { deleteFlag(flagId); };
                })(flag.id);
                
                div.appendChild(span);
                div.appendChild(btn);
                fragment.appendChild(div);
            }
            container.appendChild(fragment);
        }

        function toggleZonesVisibility() {
            zonesVisible = !zonesVisible;
            if (map && geoLayerGroup) {
                if (zonesVisible) {
                    map.addLayer(geoLayerGroup);
                } else {
                    map.removeLayer(geoLayerGroup);
                }
            }
        }

        function deleteFlag(flagId) {
            flags = flags.filter(function(f) { return f.id !== flagId; });
            saveToStorage();
            displayFlags();
            updateFlagList();
        }

        function exportData() {
            var colorGroups = {};
            var cpList = Object.keys(zones);
            
            for (var i = 0; i < cpList.length; i++) {
                var cp = cpList[i];
                var data = zones[cp];
                if (!colorGroups[data.color]) {
                    colorGroups[data.color] = {name: data.name, postalCodes: []};
                }
                colorGroups[data.color].postalCodes.push(cp);
            }

            var text = "EXPORT DES ZONES DE PERMANENCE\n================================\n\n";
            var colorKeys = Object.keys(colorGroups);
            
            for (var i = 0; i < colorKeys.length; i++) {
                var color = colorKeys[i];
                var data = colorGroups[color];
                var colorName = null;
                for (var j = 0; j < colors.length; j++) {
                    if (colors[j].hex === color) {
                        colorName = colors[j];
                        break;
                    }
                }
                text += data.name + " (" + (colorName ? colorName.name : "Couleur personnalis√©e") + ")\n";
                text += "Codes postaux (" + data.postalCodes.length + "): " + data.postalCodes.sort().join(", ") + "\n\n";
            }

            var blob = new Blob([text], {type: "text/plain"});
            var url = URL.createObjectURL(blob);
            var a = document.createElement("a");
            a.href = url;
            a.download = "zones-permanence.txt";
            a.click();
        }

        function exportJSON() {
            var exportData = {
                version: "1.0",
                date: new Date().toISOString(),
                zones: zones,
                postalData: postalData,
                flags: flags
            };
            
            var json = JSON.stringify(exportData, null, 2);
            var blob = new Blob([json], {type: "application/json"});
            var url = URL.createObjectURL(blob);
            var a = document.createElement("a");
            a.href = url;
            var dateStr = new Date().toISOString().split('T')[0];
            a.download = "zones-permanence-" + dateStr + ".json";
            a.click();
            
            alert("Configuration export√©e avec succ√®s !\n\nVous pouvez maintenant partager ce fichier JSON avec vos coll√®gues.\n\nIls pourront l'importer pour retrouver exactement vos zones color√©es.");
        }

        function importJSON(event) {
            var file = event.target.files[0];
            if (!file) return;
            
            var reader = new FileReader();
            reader.onload = function(e) {
                try {
                    var importData = JSON.parse(e.target.result);
                    
                    if (!importData.zones || !importData.postalData) {
                        alert("‚ùå Fichier JSON invalide. Assurez-vous d'importer un fichier export√© depuis cette application.");
                        return;
                    }
                    
                    if (Object.keys(zones).length > 0) {
                        if (!confirm("‚ö†Ô∏è Vous avez d√©j√† des zones color√©es.\n\nVoulez-vous remplacer votre configuration actuelle par celle du fichier import√© ?")) {
                            return;
                        }
                    }
                    
                    zones = importData.zones;
                    postalData = importData.postalData;
                    flags = importData.flags || [];
                    
                    saveToStorage();
                    showMainSection();
                    updatePostalGrid();
                    updateStats();
                    initZoneFilters();
                    
                    if (map && geoDataCache) {
                        updateMapColors();
                        displayFlags();
                    }
                    
                    updateFlagList();
                    
                    alert("‚úÖ Configuration import√©e avec succ√®s !\n\n" + Object.keys(zones).length + " codes postaux color√©s et " + flags.length + " drapeaux ont √©t√© restaur√©s.");
                    
                } catch (error) {
                    alert("‚ùå Erreur lors de l'import du fichier JSON.\n\nAssurez-vous que le fichier n'est pas corrompu.");
                    console.error(error);
                }
            };
            reader.readAsText(file);
            
            event.target.value = "";
        }

        function clearAll() {
            if (confirm("Effacer toutes les zones color√©es ET tous les drapeaux ?")) {
                zones = {};
                flags = [];
                saveToStorage();
                updatePostalGrid();
                updateStats();
                initZoneFilters();
                if (map && geoDataCache) {
                    updateMapColors();
                    displayFlags();
                }
                updateFlagList();
            }
        }

        function reloadCSV() {
            if (confirm("Voulez-vous recharger un nouveau fichier CSV ? Cela effacera les donn√©es actuelles.")) {
                postalData = [];
                zones = {};
                flags = [];
                geoDataCache = null;
                localStorage.clear();
                document.getElementById("uploadSection").classList.remove("hidden");
                document.getElementById("mainSection").classList.add("hidden");
                document.getElementById("listSection").classList.add("hidden");
                document.getElementById("mapSection").classList.add("hidden");
                document.getElementById("fileInput").value = "";
                if (map) {
                    map.remove();
                    map = null;
                    geoLayerGroup = null;
                    flagMarkers = L.layerGroup();
                    flagCircles = L.layerGroup();
                }
            }
        }

        function reloadMap() {
            if (confirm("Recharger la carte avec les nouvelles optimisations ? Vos zones color√©es seront conserv√©es.")) {
                geoDataCache = null;
                if (map) {
                    geoLayerGroup.clearLayers();
                }
                if (currentView === "map" && map) {
                    loadGeoData();
                }
            }
        }

        function saveToStorage() {
            try {
                localStorage.setItem("postalData", JSON.stringify(postalData));
                localStorage.setItem("zones", JSON.stringify(zones));
                localStorage.setItem("flags", JSON.stringify(flags));
            } catch(e) {
                console.log("Erreur sauvegarde");
            }
        }

        function loadFromStorage() {
            try {
                var savedData = localStorage.getItem("postalData");
                var savedZones = localStorage.getItem("zones");
                var savedFlags = localStorage.getItem("flags");
                
                if (savedData) {
                    postalData = JSON.parse(savedData);
                    showMainSection();
                    updatePostalGrid();
                }
                if (savedZones) {
                    zones = JSON.parse(savedZones);
                    updatePostalGrid();
                    updateStats();
                }
                if (savedFlags) {
                    flags = JSON.parse(savedFlags);
                    updateFlagList();
                }
            } catch(e) {
                console.log("Erreur chargement");
            }
        }
    </script>
</body>
</html>
